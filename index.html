<!DOCTYPE html>
<html>
    <header>
        <link href='node_modules/@fullcalendar/core/main.css' rel='stylesheet' />
        <link href='node_modules/@fullcalendar/timeline/main.css' rel='stylesheet' />
        <link href='node_modules/@fullcalendar/resource-timeline/main.css' rel='stylesheet' />
        <script src='node_modules/@fullcalendar/core/main.js'></script>
        <script src='node_modules/@fullcalendar/timeline/main.js'></script>
        <script src='node_modules/@fullcalendar/resource-common/main.js'></script>
        <script src='node_modules/@fullcalendar/resource-timeline/main.js'></script>
        <script src='node_modules/@fullcalendar/interaction/main.js'></script>
        <script language="JavaScript" type="text/javascript"
          src="https://kjur.github.io/jsrsasign/jsrsasign-latest-all-min.js">  // jwt decoder
        </script>
        <link rel='stylesheet'
          href='https://ajax.googleapis.com/ajax/libs/jqueryui/1.12.1/themes/smoothness/jquery-ui.css' />
        <script src='https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js'></script>
        <!-- BEGIN: KOALA MODIFICATIONS -->
        <script type="text/javascript"
            src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.js"></script>
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" 
          integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">
        <!-- <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js" 
          integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q" crossorigin="anonymous"></script> -->
        <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js" 
          integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl" crossorigin="anonymous"></script>
        <!-- END: KOALA MODIFICATIONS -->
    </header>
    <head>
        Hotel Shift Viewer
    </head>
    <body>
        <div id='calendar'>
        </div>
        <div class="col align-self-center">
          <button onclick=showModal()>Advertise New Shift</button>
        </div>

        <!-- Edit Shift Modal -->
        <div id="dialog-confirm" title="Shift Information" style="display:none">
          <div class="row">
            <div class="col">
              <label for="emp-name">Emp. Name: </label>
              <input type="text" id="emp-name" disabled>
            </div>
          </div>
          <div class="row">
            <div class="col">              
              <label for="start-date">Start Date: </label>
              <input type="text" id="start-date" maxlength="10" size="10">
              <label for="start">Start Time:</label>              
              <input type="text" id="start-time" name="start" maxlength="8" size="8" required>           
            </div>
          </div>
          <div class="row">
            <div class="col">
              <label for="end-date">End Date: </label>
              <input type="text" id="end-date"  maxlength="10" size="10">
              <label for="end">End Time:</label>
              <input type="text" id="end-time" name="end" maxlength="8" size="8" required></select>
            </div>
          </div>
          <div class="row">
            <div class="col">
              <label for="jobCode">Job: </label>
              <select type="text" id="jobCode" name="jobCode" ></select>
              <label for="locCode">Loc: </label>
              <select type="text" id="locCode" name="locCode" ></select>
            </div>
          </div>
        </div>

        <!-- Create Shift Modal -->
        <div id="dialog-confirm2" title="Shift Information" style="display:none">
          <div class="row">
            <div class="col">
              <label for="emp-name2">Emp. Name: </label>
              <input type="text" id="emp-name2" disabled>
            </div>
          </div>
          <div class="row">
            <div class="col">              
              <label for="start-date2">Start Date: </label>
              <input type="text" id="start-date2" maxlength="10" size="10">
              <label for="start">Start Time:</label>              
              <input type="text" id="start-time2" name="start" maxlength="8" size="8" required>           
            </div>
          </div>
          <div class="row">
            <div class="col">
              <label for="end-date">End Date: </label>
              <input type="text" id="end-date2"  maxlength="10" size="10">
              <label for="end">End Time:</label>
              <input type="text" id="end-time2" name="end" maxlength="8" size="8" required></select>
            </div>
          </div>
          <div class="row">
            <div class="col">
              <label for="jobCode2">Job: </label>
              <select type="text" id="jobCode2" name="jobCode" ></select>
              <label for="locCode2">Loc: </label>
              <select type="text" id="locCode2" name="locCode"></select>
            </div>
          </div>
        </div>

        <!-- Create Empty Shift Modal -->
        <div id="dialog-confirm3" title="Shift Information" style="display:none">
          <div class="row">
            <div class="col">              
              <label for="start-date3">Start Date: </label>
              <input type="text" id="start-date3" maxlength="10" size="10">
              <label for="start">Start Time:</label>              
              <input type="text" id="start-time3" name="start" maxlength="8" size="8" required>           
            </div>
          </div>
          <div class="row">
            <div class="col">
              <label for="end-date3">End Date: </label>
              <input type="text" id="end-date3"  maxlength="10" size="10">
              <label for="end">End Time:</label>
              <input type="text" id="end-time3" name="end" maxlength="8" size="8" required></select>
            </div>
          </div>
          <div class="row">
            <div class="col">
              <label for="jobCode3">Job: </label>
              <select type="text" id="jobCode3" name="jobCode3" ></select>
              <label for="locCode3">Loc: </label>
              <select type="text" id="locCode3" name="locCode3"></select>
            </div>
          </div>
        </div>

    </body>
    <script>
    var calendar;
    var currentEvent;
    var currentEmp;
    var urlParams = new URLSearchParams(window.location.search);
    let depID = urlParams.get("managerID");
    var payload = KJUR.jws.JWS.readSafeJSONString(b64utoutf8(depID.split(".")[1])); //jwt decode
    console.log(payload["deptId"]);
    document.addEventListener('DOMContentLoaded', function() {
      var calendarEl = document.getElementById('calendar');

      calendar = new FullCalendar.Calendar(calendarEl, {
    eventSources: [
      {
        url: './api/get_shifts.php',
        method: 'POST',
        extraParams: {
        manager_id: payload["deptId"]      
        },
        textColor: "white"
      }
    ],
    eventClick: function (event) {
      currentEvent = event.event.id;
      let str = FullCalendar.formatDate(event.event.start, {
        month: "2-digit",  //FullCalendar Formatter
        day: "2-digit",
        year: "numeric"
      });
      document.getElementById('start-date').value = str; // set start date
      str = FullCalendar.formatDate(event.event.end, {
        month: "2-digit",  //FullCalendar Formatter
        day: "2-digit",
        year: "numeric"
      });
      document.getElementById('end-date').value = str; // set end date
      str = FullCalendar.formatDate(event.event.start, {
        hour: "2-digit",  //FullCalendar Formatter
        minute: "2-digit"
      });
      document.getElementById('start-time').value = str; //set start time
      str = FullCalendar.formatDate(event.event.end, {
        hour: "2-digit",  //FullCalendar Formatter
        minute: "2-digit"
      });
      document.getElementById('end-time').value = str; // set end time
      let empName = getEmpNameByEvent(event.event);
      document.getElementById('emp-name').value = empName;
      populateJobCodes(event.event._def.resourceIds[0], event.event.extendedProps.job, "jobCode");
      populateLocations("locCode", event.event.extendedProps.location);
        $("#dialog-confirm").dialog("open"); // Shows the Shift Information Dialog Box
      },
    plugins: [ 'resourceTimeline', 'interaction' ],
    header: {
      left: 'title',
      center: 'resourceTimelineDay,resourceTimelineWeek today prev,next ',
      right: ''
    },
    slotDuration: "00:15:00",
    selectable: true,
    selectOverlap: false,
    /* selectable functionality */
    select: function(info) {
      currentEmp = info.resource.id; //so we can reference in other functions
      let str = FullCalendar.formatDate(info.start, {
        month: "2-digit",  //FullCalendar Formatter
        day: "2-digit",
        year: "numeric"
      });
      document.getElementById('start-date2').value = str; // set start date
      str = FullCalendar.formatDate(info.end, {
        month: "2-digit",  //FullCalendar Formatter
        day: "2-digit",
        year: "numeric"
      });
      document.getElementById('end-date2').value = str; // set end date
      str = FullCalendar.formatDate(info.start, {
        hour: "2-digit",  //FullCalendar Formatter
        minute: "2-digit"
      });
      document.getElementById('start-time2').value = str; //set start time
      str = FullCalendar.formatDate(info.end, {
        hour: "2-digit",  //FullCalendar Formatter
        minute: "2-digit"
      });
      document.getElementById('end-time2').value = str; // set end time
      let empName = info.resource.extendedProps.fname+" "+info.resource.extendedProps.lname;
      document.getElementById('emp-name2').value = empName;
        populateJobCodes(currentEmp, null, "jobCode2");
        populateLocations("locCode2", null);
        $("#dialog-confirm2").dialog("open"); // Shows the Shift Information Dialog Box
      },
    aspectRatio: 1.6,
    slotWidth: 20,
    resourceAreaWidth: "15%",
    contentHeight: 700,
    defaultView: 'resourceTimelineDay',
    resourceGroupField: 'department',
    resourceColumns: [{       //resources area
        labelText: "First",
        field: 'fname'
    },
    {
        labelText: "Last",
        field: 'lname'
    }],
    resources:
      {
        url: './api/get_employees.php',
        method: 'POST',
        extraParams: {
        manager_id: payload["deptId"]        
      }
      }
  });
  calendar.render();
  populateBlankShiftDropdowns("jobCode3", "locCode3");
});

$("#dialog-confirm").dialog({
    resizable: false,
    height: "auto",
    width: "525",
    autoOpen: false,
    modal: true,
    focus: false,
    clostText: 'hide',
    buttons: [{
      id: "btnSave",
      text: "Save",
      /* icon: "ui-icon-plus", */
      click: function () {
        updateShift(currentEvent);
        currentEvent = null;
        $(this).dialog("close");
      }
    },
    {
      id: "btnDelete",
      text: "Delete",
      /* icon: "ui-icon-plus", */
      click: function () {
        deleteShift(currentEvent);
        currentEvent = null;
        $(this).dialog("close");
        
      }
    }
    ]
  });

  function deleteShift(eventID){
    console.log(eventID);
    fetch('./api/delete_shift', {
      method: "POST",
      headers: {
        "Content-Type": "application/x-www-form-urlencoded",
      },
      body: $.param({
        "shift_id" : eventID //POST info
      })
  }).then( function () {
        redisplay();
  });
};

$("#dialog-confirm2").dialog({
    resizable: false,
    height: "auto",
    width: "525",
    autoOpen: false,
    modal: true,
    focus: false,
    clostText: 'hide',
    buttons: [{
      id: "btnSave",
      text: "Save",
      /* icon: "ui-icon-plus", */
      click: function () {
        createShift(currentEmp);
        currentEmp = null;
        $(this).dialog("close");
      }
    }
    ]
  });

  $("#dialog-confirm3").dialog({
    resizable: false,
    height: "auto",
    width: "525",
    autoOpen: false,
    modal: true,
    focus: false,
    clostText: 'hide',
    buttons: [{
      id: "btnSave",
      text: "Save",
      /* icon: "ui-icon-plus", */
      click: function () {
        createEmptyShift();
        $(this).dialog("close");
      }
    }
    ]
  });

  function deleteShift(eventID){
    console.log(eventID);
    fetch('./api/delete_shift', {
      method: "POST",
      headers: {
        "Content-Type": "application/x-www-form-urlencoded",
      },
      body: $.param({
        "shift_id" : eventID //POST info
      })
  }).then( function () {
        redisplay();
  });
};

function updateShift(eventID){
  var new_sDate = formatDate($('#start-date').val()); // reformatting the dates & times
  var new_eDate = formatDate($('#end-date').val());
  var new_sTime = formatTime($('#start-time').val());
  var new_eTime = formatTime($('#end-time').val());
  var new_job = $('#jobCode').val();
  var new_loc = $('#locCode').val();
  fetch('./api/update_shift.php', {
    method: "POST",
    headers: {
        "Content-Type": "application/x-www-form-urlencoded",
      },
    body: $.param({
      sDate: new_sDate,
      eDate: new_eDate,
      sTime: new_sTime, // POST data
      eTime: new_eTime,
      eventID: eventID,
      modID: payload["id"],
      job: new_job,
      loc: new_loc
    })
      }).then( function() {
        redisplay();
    })
};

function redisplay(){
  calendar.refetchEvents();
  calendar.render();
};

function formatTime(time){
  var newTime = time.split(' ');
  if(newTime[1].toUpperCase() == "PM"){
    var timeSplit = newTime[0].split(':');
    var hours = parseInt(timeSplit[0]) + 12; // convert to 24 hour time
    return (hours+":"+timeSplit[1]+":00");
  }
  else{
    return (newTime[0]+":00");
  }
};

function formatDate(date){
  var dateSplit = date.split("/");
  return (dateSplit[2]+"-"+dateSplit[0]+"-"+dateSplit[1]);
};

function getEmpNameByEvent(event){
  let resources = event.getResources();
  let empName = resources.map(function (resource) 
    {return (resource.extendedProps.fname + " " + resource.extendedProps.lname)});
  if (empName.length == 1){
    return empName[0];
  }
  else{
    alert("Emp Name failed to be found.");
  }
};

function populateJobCodes(emp_id, job_id, el){
  fetch('./api/populate_jobcodes.php', {
      method: "POST",
      headers: {
        "Content-Type": "application/x-www-form-urlencoded",
      },
      body: $.param({
        "id" : emp_id //POST info
      })
        }).then(function (response) {
          response.json().then(function (data) {
            document.getElementById(el).options.length = 0; //reset the dropdown       
            data.forEach(function (position) {
              $('#'+el).append(new Option(position["Position_"], position["JobCode"]));
            });
            if (job_id != null)
              $('#'+el).val(job_id); // set default to current job value
  })});
};

function populateLocations(el, loc_id){
  fetch('./api/populate_locations.php', {
      method: "POST",
      headers: {
        "Content-Type": "application/x-www-form-urlencoded",
      }
    }).then(function (response) {
          response.json().then(function (data) {
            document.getElementById(el).options.length = 0; //reset the dropdown      
            data.forEach(function (location) {
              $('#'+el).append(new Option(location["location_name"], location["location_id"]));
            });
            if (loc_id != null)
              $('#'+el).val(loc_id); // set default to current location value
  })});
};

function createShift(thisEmp){
  var new_sDate = formatDate($('#start-date2').val()); // reformatting the dates & times
  var new_eDate = formatDate($('#end-date2').val());
  var new_sTime = formatTime($('#start-time2').val());
  var new_eTime = formatTime($('#end-time2').val());
  var new_job = $('#jobCode2').val();
  var new_loc = $('#locCode2').val();
  fetch('./api/create_shift.php', {
    method: "POST",
    headers: {
        "Content-Type": "application/x-www-form-urlencoded",
      },
    body: $.param({
      sDate: new_sDate,
      eDate: new_eDate,
      sTime: new_sTime, // POST data
      eTime: new_eTime,
      modID: payload["id"],
      job: new_job,
      loc: new_loc,
      empID: thisEmp
    })
      }).then( function() {
        redisplay();
    })
};

function createEmptyShift(){
  var new_sDate = formatDate($('#start-date3').val()); // reformatting the dates & times
  var new_eDate = formatDate($('#end-date3').val());
  var new_sTime = formatTime($('#start-time3').val());
  var new_eTime = formatTime($('#end-time3').val());
  var new_job = $('#jobCode3').val();
  var new_loc = $('#locCode3').val();
  fetch('./api/create_empty_shift.php', {
    method: "POST",
    headers: {
        "Content-Type": "application/x-www-form-urlencoded",
      },
    body: $.param({
      sDate: new_sDate,
      eDate: new_eDate,
      sTime: new_sTime, // POST data
      eTime: new_eTime,
      modID: payload["id"],
      job: new_job,
      loc: new_loc
    })
      }).then( function() {
        redisplay();
    })
};

function populateBlankShiftDropdowns(el1, el2){
  getLocations(el2);
  getJobs(el1);
}

function getLocations(el){
  fetch('./api/get_locations.php', {
      method: "POST",
      headers: {
        "Content-Type": "application/x-www-form-urlencoded",
      },
      body: $.param({
        
      })
        }).then(function (response) {
          response.json().then(function (data) {
            document.getElementById(el).options.length = 0; //reset the dropdown       
            data.forEach(function (location) {
              $('#'+el).append(new Option(location["location_name"], location["location_id"]));
            });
  })});
}

function getJobs(el){
  fetch('./api/get_jobs.php', {
      method: "POST",
      headers: {
        "Content-Type": "application/x-www-form-urlencoded",
      },
      body: $.param({

      })
        }).then(function (response) {
          response.json().then(function (data) {
            document.getElementById(el).options.length = 0; //reset the dropdown       
            data.forEach(function (position) {
              $('#'+el).append(new Option(position["Position_"], position["JobCode"]));
            });
  })});

}

  function showModal(){
    $("#dialog-confirm3").dialog("open");
  }
    </script>    
</html>